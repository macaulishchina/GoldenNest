# 📜 开发历史

本文档记录小金库项目主要功能模块的开发历程和关键技术决策。

---

## 版本时间线

| 日期 | 里程碑 | 关键内容 |
|------|--------|----------|
| 2026-02-09 | v1.0 基础版 | 核心财务功能、家庭管理、股权系统、宠物/成就/投票 |
| 2026-02-09 | 代码质量优化 | 安全加固（速率限制、加密存储）、性能优化（N+1 查询修复）、常量提取 |
| 2026-02-10 | AI 能力第一期 | 6 个模块接入 AI（仪表盘对话、宠物、交易、清单、投资、公告） |
| 2026-02-11 | 功能大扩展 | 浮动 AI 助手、家庭赌注系统、智能记账系统（OCR/语音/批量导入/重复检测） |
| 2026-02-11 | 关键 Bug 修复 | `get_current_user` 迁移至 `security.py` 解决 ImportError |
| 2026-02-12 | AI 配置增强 | 按功能独立配置模型（19 功能×5 组）、AI 模型调用信息展示、模型下拉自定义 |

---

## 核心功能模块

### Phase 1：补齐 AI 功能入口

- 投资管理页面增加 AI 分析按钮
- 公告页面增加 AI 起草和 AI 润色按钮
- 统一 AI 按钮交互风格

### Phase 2：浮动 AI 助手

- 全局浮动按钮组件 `FloatingAIAssistant.vue`
- 支持拖拽、双击快捷跳转、长按设置菜单
- 多角色系统（小金/小喵/汪汪 + 自定义角色）
- 对话面板 `AIChatDialog.vue`，支持文字和长按语音输入

### Phase 3：家庭赌注系统

- 完整的赌注生命周期：创建 → 投注 → 揭晓 → 结算
- 数据库模型：`Bet`、`BetOption`、`BetRecord`
- 12 个 API 端点覆盖所有操作
- 前端 `BetView.vue` 卡片式布局

### Phase 4：智能记账系统

- **三种输入方式**：文字记账、拍照记账（OCR）、语音记账
- **批量导入**：支持 PDF、Excel/CSV、图片批量解析
- **3 级重复检测**：精确匹配 → 模糊匹配 → AI 语义分析
- **消费类型推断**：AI 自动判断个人消费 vs 家庭消费
- 数据库模型：`AccountingRecord`、`AccountingTag`
- 前端含进度可视化、重复确认对话框

### Phase 5：AI 配置增强

- **按功能独立配置模型**：19 个 AI 功能分 5 组，每个可独立指定服务商+模型
- **配置优先级链**：功能级 → 全局活跃服务商 → 环境变量
- **AI 调用信息展示**：ASGI 中间件注入 `X-AI-*` 响应头 + 前端 Toast 提示
- **模型选择增强**：支持推荐模型过滤和完全自定义模式

---

## 关键架构决策

### 1. 统一 AI 调用层

**决策**：所有 AI 调用必须经过 `ai_service.py`，禁止直接发 HTTP 请求。

**理由**：
- 集中管理模型选择逻辑（按功能配置 → 全局 → 环境变量）
- 统一的 429 限流重试策略
- 统一的错误上报和元数据注入

### 2. 纯 ASGI 中间件（非 BaseHTTPMiddleware）

**决策**：AI 元数据中间件使用纯 ASGI 实现，而非 Starlette 的 `BaseHTTPMiddleware`。

**理由**：`BaseHTTPMiddleware.call_next` 在独立 anyio task 中运行，`contextvars` 修改无法传回 `dispatch` 方法。纯 ASGI 中间件在同一协程上下文中执行，确保变量正确传播。

### 3. PDF 双模式解析

**决策**：PDF 导入同时使用 PyMuPDF（文本提取）和 pdfplumber（表格提取）。

**理由**：不同 PDF 格式的文本组织方式差异大，双模式互补能覆盖更多场景。

### 4. 通用审批工作流

**决策**：存款、支出、提款统一使用 `ApprovalRequest` 模型，一票否决制。

**理由**：避免为每种操作维护独立的审批逻辑，`approval.py` 一处实现覆盖所有场景。

---

## 已知限制

1. **无数据库迁移框架**：模型修改依赖自动建表 + 手动迁移（参见 [数据库迁移指南](DATABASE_MIGRATION_GUIDE.md)）
2. **无自动化测试**：建议引入 `pytest` + `vitest`
3. **头像 Base64 存储**：大量用户时建议迁移到对象存储
4. **记账功能未配置速率限制**：参见 [速率限制配置](RATE_LIMITING_GUIDE.md)

---

> 📖 相关文档：[AI 功能指南](AI_GUIDE.md) · [代码质量报告](CODE_QUALITY_REPORT.md)
